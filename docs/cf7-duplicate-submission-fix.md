# Contact Form 7 重複送信問題の修正

## 問題の概要
お問い合わせフォームの送信時に、2回処理が実行されてしまう問題が報告されました。

## 根本原因
Contact Form 7の「その他の設定」に `skip_mail: on_sent_ok` という古い設定が残っていることが原因です。この設定は現在のバージョンでは非推奨で、重複送信を引き起こす可能性があります。

## 必要な修正手順

### 重要：Contact Form 7の設定を修正する
1. WordPress管理画面にログイン
2. 「お問い合わせ」→「コンタクトフォーム」に移動
3. 「お問い合わせフォーム」（ID: 4f2cf0f）を編集
4. 「その他の設定」タブをクリック
5. `skip_mail: on_sent_ok` の行を**完全に削除**
6. 保存をクリック

## 実施した修正

### 1. 重複送信防止スクリプトの追加
`/assets/js/features/cf7-duplicate-prevention.js` を新規作成
- フォーム送信中のフラグ管理
- 最小送信間隔（3秒）のチェック
- 送信ボタンの無効化とテキスト変更
- タイムスタンプによる重複検知

### 2. 問題のある機能の無効化
`/assets/js/features/cf7-fix.js` の以下の機能をコメントアウト：
- `window.submitCF7Fallback()` - フォールバック送信機能
- `window.triggerCF7Submit()` - 手動イベントトリガー機能

### 3. スクリプトの読み込み設定
`/inc/assets.php` に重複送信防止スクリプトの読み込みを追加

### 4. functions.phpのイベントリスナーを改善
`wpcf7mailsent`イベントのリスナーに重複防止フラグを追加
- `isRedirecting`フラグで重複リダイレクトを防止
- イベント発火回数をカウントしてログ出力

### 5. サーバーサイドの重複防止（オプション）
`/inc/cf7-duplicate-fix.php` を作成（必要に応じて読み込み）
- セッションベースの重複チェック
- ハッシュ値による同一内容の送信防止

## テスト手順

### 基本的なテスト
1. お問い合わせページ（/contact/）にアクセス
2. ブラウザの開発者ツール（F12）を開き、Consoleタブを表示
3. フォームに必要事項を入力
4. 送信ボタンをクリック
5. コンソールログで以下を確認：
   - "CF7 Duplicate Prevention: Before submit event fired. Count: 1" が1回のみ表示される
   - 送信回数が1回であることを確認

### 詳細なデバッグ
1. URLに `?debug=cf7` を追加してアクセス（例：/contact/?debug=cf7）
2. コンソールで5秒ごとに状態が表示される
3. フォーム送信後、コンソールで以下のコマンドを実行：
   ```javascript
   CF7DuplicatePrevention.analyze()
   ```
4. 送信間隔や重複検知の結果を確認

### 重複送信テスト
1. 送信ボタンを素早く2回クリック
2. 以下の動作を確認：
   - 2回目のクリックがブロックされる
   - コンソールに "Blocking duplicate submission!" が表示される
   - ボタンが「送信中...」に変わり、無効化される

### モバイルデバイステスト
1. スマートフォンまたはタブレットでアクセス
2. 同様にフォームを送信
3. タップの二重送信がブロックされることを確認

## トラブルシューティング

### 問題が解決しない場合
1. ブラウザのキャッシュをクリア
2. 他のプラグインとの競合を確認
3. Contact Form 7のバージョンを確認
4. コンソールで以下を実行して状態を確認：
   ```javascript
   CF7DuplicatePrevention.getStatus()
   ```

### デバッグ情報の収集
問題が続く場合は、以下の情報を収集：
- ブラウザとバージョン
- Contact Form 7のバージョン
- コンソールのエラーメッセージ
- `CF7DuplicatePrevention.analyze()` の結果

## 今後の検討事項
1. サーバーサイドでの重複チェックの実装
2. Contact Form 7の設定見直し
3. 他のフォームプラグインへの移行検討