-- Contact Form 7 診断用SQL
-- phpMyAdminで順番に実行してください

-- 1. Contact Form 7のフォームデータを確認
-- post_contentの最初の500文字を表示
SELECT 
    ID, 
    post_title,
    LEFT(post_content, 500) as content_preview
FROM wp_posts 
WHERE post_type = 'wpcf7_contact_form' 
AND post_status = 'publish';

-- 2. messagesプロパティを含む部分を検索
-- messagesが文字列として保存されているかチェック
SELECT 
    ID, 
    post_title,
    SUBSTRING(post_content, 
        LOCATE('messages', post_content) - 20, 
        200) as messages_area
FROM wp_posts 
WHERE post_type = 'wpcf7_contact_form' 
AND post_status = 'publish'
AND post_content LIKE '%messages%';

-- 3. 特定のフォームの詳細を確認（IDを実際のフォームIDに置き換えてください）
-- フォームID "4f2cf0f" に対応する実際のIDを使用
SELECT 
    ID,
    post_title,
    post_content
FROM wp_posts 
WHERE post_type = 'wpcf7_contact_form' 
AND (post_title LIKE '%お問い合わせ%' OR post_name LIKE '%4f2cf0f%');

-- 4. シリアライズデータの構造を確認
-- messages";s: という文字列があれば、messagesが文字列として保存されている
SELECT 
    ID,
    post_title,
    CASE 
        WHEN post_content LIKE '%messages";s:%' THEN 'STRING (問題あり)'
        WHEN post_content LIKE '%messages";a:%' THEN 'ARRAY (正常)'
        ELSE '不明'
    END as messages_type
FROM wp_posts 
WHERE post_type = 'wpcf7_contact_form' 
AND post_status = 'publish';

-- 5. バックアップの作成（実行前に必ず）
-- テーブル名を適宜変更してください
CREATE TABLE wp_posts_backup_cf7_fix AS 
SELECT * FROM wp_posts 
WHERE post_type = 'wpcf7_contact_form';